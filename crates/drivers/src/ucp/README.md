# Universal Commerce Protocol (UCP) Driver

**Location:** `crates/drivers/src/ucp`

The **UCP Driver** serves as the "Digital Hardware" interface for the IOI Agentic Economy. It allows autonomous agents to interact with off-chain merchants adhering to the Universal Commerce Protocol standards, enabling capabilities like product discovery, cart management, and secure checkout.

## ðŸ— Architecture & Security Model

Unlike traditional API clients, the UCP Driver runs within the **Workload Container** (the execution environment). To maintain the strict security isolation required by the IOI Kernel:

1.  **Logic-Only Execution:** This driver does **not** perform network I/O directly. It constructs canonical HTTP requests and parses responses.
2.  **Secure Token Injection:** The driver never handles raw payment credentials (e.g., Stripe tokens, API keys). Instead, it inserts a **Secret Reference** (Magic String) into the payload.
3.  **Guardian Delegation:** The actual network transmission is delegated to the **Guardian Container**. The Guardian detects the secret reference, retrieves the actual credential from its encrypted vault, injects it into the request, and signs the traffic.

### The Injection Pattern
When constructing a checkout payload, the driver generates a placeholder:

```json
{
  "payment": {
    "handlers": [{
      "id": "stripe",
      "token": "{{SECRET:stripe_connect_customer_token}}"
    }]
  }
}
```

The Guardian replaces `{{SECRET:...}}` with the actual high-entropy secret before the packet leaves the physical node.

## ðŸ“¦ Core Components

### `UcpDriver`
The primary entry point for agentic commerce logic.

*   **Discovery:** Fetches and parses the `/.well-known/ucp` manifest from a merchant domain to determine supported capabilities and payment methods.
*   **Checkout:** Constructs the JSON payload required to finalize a purchase.
*   **Receipt Validation:** Verifies that the merchant's response constitutes a valid Proof of Purchase.

### Data Structures
*   **`UcpManifest`**: Represents the merchant's capabilities (Version, Payment Handlers).
*   **`LineItem`**: A specific product and quantity to purchase.
*   **`PaymentHandler`**: Configuration for a specific payment processor (e.g., Stripe, Coinbase Commerce).

## ðŸš€ Usage Example

This flow demonstrates how the `UcpDriver` is used within an Agent Service to execute a purchase.

```rust
use ioi_drivers::ucp::{UcpDriver, LineItem};

async fn purchase_flow(merchant_url: &str) -> Result<()> {
    let driver = UcpDriver::new();

    // 1. Discovery Phase (Construct Request)
    let (url, method) = driver.build_discovery_request(merchant_url);
    
    // ... (Send request via Guardian/VerifiedHttpRuntime) ...
    // let response_bytes = ...;

    // 2. Parse Manifest
    let manifest = driver.parse_discovery_response(&response_bytes)?;
    println!("Merchant supports: {:?}", manifest.payment.handlers);

    // 3. Build Checkout Payload
    let items = vec![LineItem {
        id: "sku_12345".to_string(),
        quantity: 1
    }];
    
    // The "payment_token_ref" refers to a key stored in the Guardian's vault
    let payload = driver.build_checkout_payload(
        &items,
        "agent@example.com",
        "stripe",
        "my_stripe_card_token" 
    )?;

    // 4. Send Checkout (via Guardian)
    // The Guardian will see the {{SECRET:my_stripe_card_token}} placeholder
    // and replace it with the real token before sending to the merchant.
    
    // ... (Send payload) ...
    // let receipt_bytes = ...;

    // 5. Validate Receipt
    let status = driver.validate_receipt(&receipt_bytes)?;
    println!("Purchase complete. Status: {}", status);
    
    Ok(())
}
```

## ðŸ”’ Policy Integration

Actions generated by this driver map to specific permissions in the **Agency Firewall**:

*   **`ucp::discovery`**: (Low Risk) Fetching manifests. Often allowed by default.
*   **`ucp::checkout`**: (High Risk) Spending funds. Requires strict **Spend Limits** and often **User Approval (2FA)** via the Gate Window.

## ðŸ“„ Standards Compliance

This implementation adheres to the **UCP v1 Draft Specification** for:
*   Manifest Discovery (`/.well-known/ucp`)
*   JSON-RPC Checkout Schema
*   Idempotency Keys