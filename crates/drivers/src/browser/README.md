# IOI Browser Driver

The **IOI Browser Driver** provides a high-level, asynchronous interface for agents to interact with the web. It serves as the "Digital Eyes" for web-based tasks within the IOI Kernel's Agentic Service.

Built on top of [chromiumoxide](https://github.com/mattsse/chromiumoxide), it communicates directly with a Chrome/Chromium instance via the **Chrome DevTools Protocol (CDP)**, enabling deterministic control over navigation, DOM extraction, and interaction.

## Features

*   **Headless Automation**: Controls a local Chrome instance (headless by default).
*   **Context Extraction**: Retrieves full DOM/HTML content to feed into the Agent's context window (SCS).
*   **Interaction**: Supports clicking elements via CSS selectors.
*   **Concurrency**: Thread-safe architecture using `Arc<Mutex<...>>`, allowing the driver to be shared across the Agent's execution loop.
*   **Runtime Agnostic**: Automatically detects if it is running within a Tokio runtime or needs to spawn its own background thread for the CDP event loop.

## Architecture

The driver encapsulates the complexity of the CDP event loop. When `launch()` is called (or lazily triggered by the first action):

1.  It attempts to locate a compatible Chrome binary on the host system.
2.  It spawns the browser process.
3.  It spawns a background Tokio task to handle the websocket message pump.
4.  It manages a persistent `Page` handle to maintain session state across agent steps.

## Usage

This driver is primarily used by the `DesktopAgentService` (specifically the `ToolExecutor`) to fulfill `browser__*` tool calls generated by the AI.

### Example

```rust
use ioi_drivers::browser::BrowserDriver;

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    let driver = BrowserDriver::new();

    // 1. Navigate to a URL
    println!("Navigating...");
    let content = driver.navigate("https://example.com").await?;
    println!("Page content length: {}", content.len());

    // 2. Interact with the page
    // (Assuming there is an element with id="submit-button")
    driver.click_selector("#submit-button").await?;

    // 3. Extract updated state
    let updated_dom = driver.extract_dom().await?;
    
    Ok(())
}
```

## System Requirements

This driver requires a Chromium-based browser to be installed on the host machine. It searches standard installation paths for:
*   Chrome
*   Chromium

## Security Constraints

When running within the IOI Kernel:
1.  **Network Isolation**: All navigation requests are subject to the **Agency Firewall** rules (e.g., domain whitelisting).
2.  **Sandbox**: The browser runs as a child process of the driver. In "User Mode" (Mode 0), it runs with the user's privileges. In "Validator Mode", it should be sandboxed (implementation pending).

## API Reference

### `navigate(url: &str) -> Result<String>`
Navigates the active tab to the specified URL and waits for the load event. Returns the page content (HTML).

### `extract_dom() -> Result<String>`
Returns the outer HTML of the current page state.

### `click_selector(selector: &str) -> Result<()>`
Finds an element matching the CSS selector and simulates a click event.